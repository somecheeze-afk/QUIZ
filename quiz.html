<!doctype html>
<html lang="ja">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>クイズ</title><link rel="stylesheet" href="style.css"/></head>
<body>
<div class="wrap">
<section class="card">
<div class="progress"><div id="bar" class="bar"></div></div>
<div id="timerWrap" class="timer"><div id="tbar" class="timerbar"></div><div id="tcount" class="count">5</div></div>
<h2 id="question"></h2><div id="choices" class="choices"></div>
<div class="end-actions"><a id="back" href="index.html" class="btn">トップに戻る</a><button id="next" class="btn" disabled>次へ ▶</button></div>
<div id="summary" class="summary muted"></div><span id="status" class="muted"></span>
</section></div>
<script>
function $(id){return document.getElementById(id);}function getParam(n){var m=location.search.match(new RegExp("[?&]"+n+"=([^&]+)"));return m?decodeURIComponent(m[1]):null;}
var quizId=getParam("id"),reqCount=parseInt(getParam("count")||"0",10),mode=getParam("mode")||"challenge",LIMIT=(mode==="challenge")?5:Infinity;
var quiz=null,index=0,correct=0,selected=[],timerId=null,qStart=0,qTimes=[];
function loadQuiz(){fetch("quizzes/"+quizId+".json").then(r=>r.json()).then(j=>{quiz=j;var src=quiz.questions.slice();src.sort(()=>Math.random()-0.5);selected=(reqCount>0)?src.slice(0,reqCount):src;if(mode==="normal")$("timerWrap").style.display="none";showQ();});}
function showQ(){var q=selected[index];$("status").innerText="";$("question").innerText=q.q;renderChoices(q);$("bar").style.width=(index/selected.length*100)+"%";$("next").disabled=true;qStart=Date.now();startTimer();}
function renderChoices(q){var wrap=$("choices");wrap.innerHTML="";q.choices.forEach((c,i)=>{var b=document.createElement("button");b.className="choice";b.innerText=c;b.onclick=()=>{stopTimer();disableChoices();var el=(Date.now()-qStart)/1000;qTimes.push(+el.toFixed(2));if(i===q.answer){correct++;b.classList.add("correct");$("status").innerText="正解！";}else{b.classList.add("wrong");$("status").innerText="不正解…正解は「"+q.choices[q.answer]+"」";revealCorrect(q);} $("next").disabled=false;};wrap.appendChild(b);});}
function disableChoices(){document.querySelectorAll(".choice").forEach(x=>x.disabled=true);}function revealCorrect(q){var btns=document.querySelectorAll(".choice");btns.forEach((b,i)=>{if(i===q.answer)b.classList.add("correct");else b.classList.add("dim");});}
function startTimer(){if(!isFinite(LIMIT))return;var tbar=$("tbar"),tcount=$("tcount");var remain=LIMIT;clearInterval(timerId);timerId=setInterval(()=>{remain-=0.1;var w=Math.max(0,remain/LIMIT*100);tbar.style.width=w+"%";tcount.innerText=Math.ceil(remain);if(remain<=0){clearInterval(timerId);timeUp();}},100);}
function stopTimer(){clearInterval(timerId);}function timeUp(){var q=selected[index];disableChoices();revealCorrect(q);$("status").innerText="時間切れ…正解は「"+q.choices[q.answer]+"」";$("next").disabled=false;}
$("next").onclick=()=>{index++;if(index<selected.length)showQ();else finish();};
function saveRec(id,mode,rec){var k="quizRecords:"+id+":"+mode;var arr=JSON.parse(localStorage.getItem(k)||"[]");arr.push(rec);localStorage.setItem(k,JSON.stringify(arr));}
function bestTime(id,mode){try{var arr=JSON.parse(localStorage.getItem("quizRecords:"+id+":"+mode)||"[]");var best=null;arr.forEach(r=>{if(r.correct===r.total&&typeof r.time==="number"){if(best==null||r.time<best)best=r.time;}});return best;}catch(e){return null;}}
function finish(){stopTimer();$("bar").style.width="100%";var total=selected.length;var title=(mode==="challenge")?"（チャレンジ）":"（ノーマル）";$("question").innerText="終了！ "+title+" 正解数："+correct+"/"+total;$("choices").innerHTML="";$("status").innerText="";$("next").style.display="none";
var html="";if(correct===total){var sum=qTimes.reduce((a,b)=>a+b,0);var totalTime=+sum.toFixed(2);if(mode==="challenge"&&total===quiz.questions.length){var rec={quizId:quizId,mode:mode,date:new Date().toISOString(),correct:correct,total:total,time:totalTime,perQuestion:qTimes};saveRec(quizId,mode,rec);}var best=bestTime(quizId,mode);html+="全問正解！ 合計タイム：<b>"+totalTime+"秒</b>";if(best!=null)html+=' <span class="best">自己ベスト：'+best.toFixed(2)+'秒</span>';}
else{html+="正解数："+correct+"/"+total+"（全問正解でタイム記録）";}var rate=correct/total;var msg="";if(rate===1)msg="パーフェクト！🎉";else if(rate>=0.8)msg="惜しい！あと少し！✨";else if(rate>=0.5)msg="半分以上正解！次は満点を目指そう💪";else msg="まだまだこれから！🔥";html+="<br><br><b>"+msg+"</b>";$("summary").innerHTML=html;}
loadQuiz();
</script>
</body></html>