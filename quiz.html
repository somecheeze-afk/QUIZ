<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>クイズ</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="wrap">
    <section class="card rise">
      <div class="progress"><div id="bar" class="bar"></div></div>
      <h2 id="question"></h2>
      <div id="choices" class="choices"></div>
      <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
        <button id="next" class="btn" disabled>次へ ▶</button>
        <span id="status" class="muted"></span>
      </div>
    </section>
  </div>

<script>
// ====== Audio ======
let audioCtx;
function ensureCtx(){
  if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
  if(audioCtx.state === "suspended"){ audioCtx.resume(); }
}
function beep(freq, dur=0.14, type="sine", vol=0.08, when=0){
  ensureCtx(); const t=audioCtx.currentTime+when;
  const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
  o.type=type; o.frequency.setValueAtTime(freq,t);
  o.connect(g); g.connect(audioCtx.destination);
  g.gain.setValueAtTime(0.0001,t);
  g.gain.exponentialRampToValueAtTime(vol,t+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  o.start(t); o.stop(t+dur+0.02);
}
function sfxCorrect(){ [493.88,659.25,880.0].forEach((f,i)=>beep(f,0.12,"sine",0.08,i*0.08)); }
function sfxWrong(){
  ensureCtx(); const t=audioCtx.currentTime;
  const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
  o.type="sawtooth"; o.frequency.setValueAtTime(220,t);
  o.frequency.exponentialRampToValueAtTime(120,t+0.35);
  o.connect(g); g.connect(audioCtx.destination);
  g.gain.setValueAtTime(0.001,t);
  g.gain.linearRampToValueAtTime(0.07,t+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001,t+0.36);
  o.start(t); o.stop(t+0.38);
}

// ====== Quiz ======
const params=new URLSearchParams(location.search);
const id=params.get("id");
const count=parseInt(params.get("count")||"0");
let quiz,index=0,correct=0,selected=[];

async function loadQuiz(){
  const res=await fetch(`quizzes/${id}.json`,{cache:"no-store"});
  quiz=await res.json();
  selected=quiz.questions.slice().sort(()=>Math.random()-0.5).slice(0,count||quiz.questions.length);
  showQuestion();
}
function showQuestion(){
  const q=selected[index];
  document.getElementById("question").textContent=q.q;
  const wrap=document.getElementById("choices");
  wrap.innerHTML="";
  q.choices.forEach((c,i)=>{
    const b=document.createElement("button");
    b.className="choice rise"; b.textContent=c;
    b.onclick=()=>{
      document.querySelectorAll(".choice").forEach(btn=>btn.disabled=true);
      if(i===q.answer){
        correct++; b.classList.add("correct"); document.getElementById("status").textContent="正解！ "+(q.explain||""); sfxCorrect();
      }else{
        b.classList.add("wrong"); document.getElementById("status").textContent="不正解… 正解は「"+q.choices[q.answer]+"」。 "+(q.explain||""); sfxWrong();
      }
      document.getElementById("next").disabled=false;
    };
    wrap.appendChild(b);
  });
  document.getElementById("bar").style.width=`${(index/selected.length)*100}%`;
}
document.getElementById("next").onclick=()=>{
  index++; document.getElementById("status").textContent="";
  document.getElementById("next").disabled=true;
  if(index<selected.length){ showQuestion(); }
  else{
    document.getElementById("bar").style.width="100%";
    document.getElementById("question").textContent=`終了！ 正解数：${correct}/${selected.length}`;
    document.getElementById("choices").innerHTML="";
  }
};
loadQuiz();
document.addEventListener("pointerdown",()=>{try{ensureCtx()}catch(e){}},{once:true});
</script>
</body>
</html>
