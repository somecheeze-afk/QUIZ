<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>クイズ</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="progress"><div id="bar" class="bar"></div></div>
      <h2 id="question"></h2>
      <div id="choices" class="choices"></div>
      <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
        <button id="next" class="btn" disabled>次へ ▶</button>
        <span id="status" class="muted"></span>
      </div>
    </section>
  </div>

<script>
const params=new URLSearchParams(location.search);
const id=params.get("id");
const count=parseInt(params.get("count")||"0");
let quiz,index=0,correct=0,selected=[];

async function loadQuiz(){
  const res=await fetch(`quizzes/${id}.json`,{cache:"no-store"});
  quiz=await res.json();
  // シャッフルして count 問だけ選ぶ
  selected=quiz.questions.sort(()=>Math.random()-0.5).slice(0,count||quiz.questions.length);
  showQuestion();
}
function showQuestion(){
  const q=selected[index];
  document.getElementById("question").textContent=q.q;
  const wrap=document.getElementById("choices");
  wrap.innerHTML="";
  q.choices.forEach((c,i)=>{
    const b=document.createElement("button");
    b.className="choice"; b.textContent=c;
    b.onclick=()=>{
      document.querySelectorAll(".choice").forEach(btn=>btn.disabled=true);
      if(i===q.answer){
        correct++; b.classList.add("correct"); document.getElementById("status").textContent="正解！ "+(q.explain||"");
      }else{
        b.classList.add("wrong"); document.getElementById("status").textContent="不正解… 正解は「"+q.choices[q.answer]+"」。 "+(q.explain||"");
      }
      document.getElementById("next").disabled=false;
    };
    wrap.appendChild(b);
  });
  document.getElementById("bar").style.width=`${(index/selected.length)*100}%`;
}
document.getElementById("next").onclick=()=>{
  index++; document.getElementById("status").textContent="";
  document.getElementById("next").disabled=true;
  if(index<selected.length){showQuestion();}
  else{
    document.getElementById("bar").style.width="100%";
    document.getElementById("question").textContent=`終了！ 正解数：${correct}/${selected.length}`;
    document.getElementById("choices").innerHTML="";
  }
};
loadQuiz();
</script>
</body>
</html>