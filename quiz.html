<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>クイズ</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <canvas id="fx" style="position:fixed;inset:0;pointer-events:none;z-index:5;display:none"></canvas>

  <div class="wrap">
    <section class="card">
      <div class="progress"><div id="bar" class="bar"></div></div>

      <div id="timerWrap" class="timer">
        <div id="tbar" class="timerbar"></div>
        <div id="tcount" class="count">5</div>
      </div>

      <h2 id="question"></h2>
      <div id="choices" class="choices"></div>

      <div class="end-actions">
        <a id="back" href="index.html" class="btn" style="display:none">トップに戻る</a>
        <button id="next" class="btn" disabled>次へ ▶</button>
      </div>

      <div id="summary" class="summary muted"></div>
      <span id="status" class="muted"></span>
    </section>
  </div>

<script>
/* ========= ユーティリティ ========= */
function $(id){ return document.getElementById(id); }
function qs(sel){ return document.querySelector(sel); }

/* ========= オーディオ（効果音） ========= */
var audioCtx;
function ensureCtx(){ if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } if(audioCtx.state === "suspended"){ audioCtx.resume(); } }
function beep(freq, dur, type, vol, when){
  dur = (dur==null)?0.14:dur; type = type||"sine"; vol = (vol==null)?0.08:vol; when = when||0;
  ensureCtx(); var t = audioCtx.currentTime + when;
  var o = audioCtx.createOscillator(); var g = audioCtx.createGain();
  o.type = type; o.frequency.setValueAtTime(freq, t); o.connect(g); g.connect(audioCtx.destination);
  g.gain.setValueAtTime(0.0001, t); g.gain.exponentialRampToValueAtTime(vol, t+0.01); g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
  o.start(t); o.stop(t+dur+0.02);
}
function sfxCorrect(){ var f=[493.88,659.25,880.0]; for(var i=0;i<f.length;i++) beep(f[i],0.12,"sine",0.08,i*0.08); }
function sfxWrong(){
  ensureCtx(); var t=audioCtx.currentTime; var o=audioCtx.createOscillator(); var g=audioCtx.createGain();
  o.type="sawtooth"; o.frequency.setValueAtTime(220,t); o.frequency.exponentialRampToValueAtTime(120,t+0.35);
  o.connect(g); g.connect(audioCtx.destination);
  g.gain.setValueAtTime(0.001,t); g.gain.linearRampToValueAtTime(0.07,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.36);
  o.start(t); o.stop(t+0.38);
}

/* ========= 花火（簡易） ========= */
var cvs = $("fx"), ctx = cvs.getContext("2d");
function resize(){ cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
window.addEventListener("resize", resize);
function fireworks(duration){
  duration = duration||2500;
  resize(); cvs.style.display="block";
  var particles=[], colors=['#fde047','#fb923c','#60a5fa','#34d399','#f472b6'];
  var start = Date.now();
  function burst(x,y){
    for(var i=0;i<80;i++){
      var a = Math.random()*Math.PI*2, v=(Math.random()*2+1);
      particles.push({x:x,y:y,vx:Math.cos(a)*v,vy:Math.sin(a)*v,life:1,color:colors[(Math.random()*colors.length)|0]});
    }
  }
  var timer = setInterval(function(){ burst(Math.random()*cvs.width, Math.random()*cvs.height*0.6+cvs.height*0.1); }, 350);
  function tick(){
    ctx.clearRect(0,0,cvs.width,cvs.height);
    for(var i=0;i<particles.length;i++){
      var p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.02; p.life*=0.98;
      ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,2,2);
    }
    if(Date.now()-start<duration){ requestAnimationFrame(tick); }
    else{ clearInterval(timer); cvs.style.display="none"; }
  }
  requestAnimationFrame(tick);
}

/* ========= 記録保存（localStorage） ========= */
function recKey(id,mode){ return "quizRecords:"+id+":"+mode; }
function loadRecs(id,mode){ try{ return JSON.parse(localStorage.getItem(recKey(id,mode))||"[]"); }catch(e){ return []; } }
function saveRec(id,mode,rec){ var arr=loadRecs(id,mode); arr.push(rec); localStorage.setItem(recKey(id,mode), JSON.stringify(arr)); }
function bestTime(id,mode){
  var arr=loadRecs(id,mode); var best=null;
  for(var i=0;i<arr.length;i++){ var r=arr[i]; if(r.correct===r.total && typeof r.time==="number"){ if(best===null||r.time<best) best=r.time; } }
  return best;
}

/* ========= パラメータ ========= */
function getParam(name){
  var m = location.search.match(new RegExp("[?&]"+name+"=([^&]+)"));
  return m ? decodeURIComponent(m[1]) : null;
}
var quizId = getParam("id");
var reqCount = parseInt(getParam("count")||"0",10);
var mode = getParam("mode") || "challenge"; // デフォルトはチャレンジ互換
var LIMIT = (mode==="challenge") ? 5 : Infinity; // 秒

/* ========= 状態 ========= */
var quiz = null, index = 0, correct = 0, selected = [];
var timerId = null, qStart = 0, qTimes = []; // 各問の秒数

/* ========= ロード & 描画 ========= */
function loadQuiz(){
  fetch("quizzes/"+quizId+".json", {cache:"no-store"})
  .then(function(res){ if(!res.ok) throw new Error("load error"); return res.json(); })
  .then(function(json){
    quiz = json;
    var src = quiz.questions.slice(0);
    // シャッフル
    src.sort(function(){ return Math.random()-0.5; });
    selected = (reqCount>0) ? src.slice(0, reqCount) : src;
    if(mode==="normal"){ $("timerWrap").style.display="none"; }
    showQuestion();
  })
  .catch(function(){ $("question").innerText = "問題の読み込みに失敗しました"; });
}

function startTimer(){
  if(!isFinite(LIMIT)) return; // ノーマルはタイマー無し
  var tbar=$("tbar"), tcount=$("tcount");
  var remain = LIMIT, step=100;
  tcount.innerText = Math.ceil(remain);
  tbar.style.transition="none"; tbar.style.width="100%"; tbar.offsetWidth; // reflow
  tbar.style.transition="width .1s linear";
  clearInterval(timerId);
  timerId = setInterval(function(){
    remain -= step/1000;
    var w = Math.max(0, remain/LIMIT*100);
    tbar.style.width = w+"%";
    var num = Math.max(0, Math.ceil(remain));
    if(tcount.innerText !== String(num)){
      tcount.innerText = num;
      // 数字のポップ（簡易）
      tcount.className = "count pulse";
      setTimeout(function(){ tcount.className = "count"; }, 260);
    }
    if(remain<=0){ clearInterval(timerId); timeUp(); }
  }, step);
}
function stopTimer(){ clearInterval(timerId); }

function renderChoices(q){
  var wrap = $("choices"); wrap.innerHTML = "";
  for(var i=0;i<q.choices.length;i++){
    (function(i0){
      var c = q.choices[i0];
      var b = document.createElement("button");
      b.className = "choice"; b.appendChild(document.createTextNode(c));
      b.onclick = function(){
        stopTimer();
        disableAllChoices();
        b.classList.add("clicked");
        var elapsed = (Date.now() - qStart)/1000; qTimes.push(Number(elapsed.toFixed(2)));
        if(i0===q.answer){ correct++; b.classList.add("correct"); $("status").innerText = "正解！ "+(q.explain||""); sfxCorrect(); }
        else{ b.classList.add("wrong"); $("status").innerText = "不正解… 正解は「"+q.choices[q.answer]+"」。 "+(q.explain||""); sfxWrong(); revealCorrect(q); }
        $("next").disabled = false;
      };
      wrap.appendChild(b);
    })(i);
  }
}
function disableAllChoices(){
  var btns = document.querySelectorAll(".choice");
  for(var i=0;i<btns.length;i++){ btns[i].disabled = true; }
}
function revealCorrect(q){
  var btns = document.querySelectorAll(".choice");
  for(var i=0;i<btns.length;i++){
    btns[i].classList.add("dim");
    if(i===q.answer){ btns[i].classList.remove("dim"); btns[i].classList.add("correct"); }
  }
}
function timeUp(){
  var q=selected[index];
  disableAllChoices(); revealCorrect(q);
  var elapsed = (Date.now() - qStart)/1000; qTimes.push(Number(elapsed.toFixed(2)));
  $("status").innerText = "時間切れ… 正解は「"+q.choices[q.answer]+"」";
  sfxWrong();
  $("next").disabled=false;
}
function showQuestion(){
  var q = selected[index];
  $("status").innerText = "";
  $("question").innerText = q.q;
  renderChoices(q);
  $("bar").style.width = (index/selected.length*100)+"%";
  $("next").disabled = true;
  qStart = Date.now();
  startTimer();
}

$("next").onclick = function(){
  index++;
  if(index<selected.length){ showQuestion(); }
  else{ finish(); }
};

/* ========= 終了処理 ========= */
function finish(){
  stopTimer();
  $("bar").style.width="100%";
  var total = selected.length;
  var title = (mode==="challenge")?"（チャレンジ）":"（ノーマル）";
  $("question").innerText = "終了！ "+title+" 正解数："+correct+"/"+total;
  $("choices").innerHTML="";
  $("status").innerText="";
  $("next").style.display="none";
  $("back").style.display="inline-flex";

  var html = "";
  if(correct===total){
    var sum = 0; for(var i=0;i<qTimes.length;i++) sum+=qTimes[i];
    var totalTime = Number(sum.toFixed(2));
    if(mode==="challenge"){
      var rec = {quizId:quizId, mode:mode, date:new Date().toISOString(), correct:correct, total:total, time:totalTime, perQuestion:qTimes};
      saveRec(quizId, mode, rec);
    }
    var best = bestTime(quizId, mode);
    html += "全問正解！ 合計タイム：<b>"+totalTime+"秒</b>";
    if(best!=null){ html += ' <span class="best">自己ベスト：'+best.toFixed(2)+'秒</span>'; }
    fireworks();
  }else{
    html += "正解数："+correct+"/"+total+"（全問正解でタイム記録）";
  }
  $("summary").innerHTML = html;
}

/* ========= 起動 ========= */
document.addEventListener("pointerdown", function(){ try{ ensureCtx(); }catch(e){} }, {once:true});
loadQuiz();
</script>
</body>
</html>
